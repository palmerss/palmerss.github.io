<html>
  <head>
    <script
        src="https://unpkg.com/algosdk@1.12.0/dist/browser/algosdk.min.js"
        integrity="sha384-N6rRZtVTe4Rvktk9jRWB/jo+NHuNpd2Uh87V0GndIMZbWkKKZZfn1FuzORyMypsZ"
        crossorigin="anonymous"
        ></script>
    <script src="/myalgo.min.js" crossorigin="anonymous"></script>
    <script src="/msgpackr.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <div style="margin: auto; width: 30%">
      <form>
        <input type="radio" name="network" value="0" checked>TestNet</input> 
        <input type="radio" name="network" value="1">MainNet</input> 
        <br>
        <input type="radio" name="signer" value="0" checked>AlgoSigner</input> 
        <input type="radio" name="signer" value="1">MyAlgo</input> 
        <br>
        <label>Transaction (base64):</label>
        <br>
        <textarea id="txn" name="txn" style="width: 100%; height: 20%">gaN0eG6Ko2FtdM0H0KNmZWXNA+iiZnbOARJkfaNnZW6sdGVzdG5ldC12MS4womdoxCBIY7UYpLPITsgQ8i1PEIHLD3HwWaesIN7GL39w5Qk6IqJsds4BEmhlpG5vdGXECJpx3TAQtoLpo3JjdsQgx/zNsljw1BicK/i21o7ml1CGQrCtAB8x/LkYw1S6hZqjc25kxCCPFU77+/Oqtnap8HWJLczNsVocQVlc2MCxcsXgPvyJ3KR0eXBlo3BheQ==</textarea><br>
        <input type="button" value="Sign" onclick="signTxn()"></input>
      <form>
      <p id="signedTxn" style="overflow-wrap: anywhere">
      </p>
      <input type="button" value="Send" id="sendTxnButton" onclick="sendTxn()" style="display: none"></input>
    </div>
    <script crossorigin="anonymous">
      const myAlgoConnect = new MyAlgoConnect();
      const sendTxnButton = document.getElementById("sendTxnButton");
      const signedTxnElement = document.getElementById("signedTxn");
      let base64SignedTxn = null;
      async function signTxn() {
        await AlgoSigner.connect();
        let txn = msgpackr.unpack(AlgoSigner.encoding.base64ToMsgpack(document.forms[0].txn.value));
        if ("txn" in txn)
          txn = txn.txn;

        const network = ["TestNet", "MainNet"][document.forms[0].network.value]
        let params = await AlgoSigner.algod({
          ledger: network,
          path: '/v2/transactions/params',
        })
        txn["gen"] = params["genesis-id"]

        const base64txn = AlgoSigner.encoding.msgpackToBase64(msgpackr.pack(txn));
        signedTxn = null;
        base64SignedTxn = null;
        signedTxnElement.innerHTML = "";
        sendTxnButton.style.display = "none";
        switch (parseInt(document.forms[0].signer.value)) {
          case 0:
            signedTxn = (await AlgoSigner.signTxn([
                    {
                            txn: base64txn
                    }
            ]))[0];
            base64SignedTxn = signedTxn.blob;
            signedTxn.blob = AlgoSigner.encoding.base64ToMsgpack(base64SignedTxn)
            break;
          case 1:
            let accountsSharedByUser = await myAlgoConnect.connect();
            signedTxn = (await myAlgoConnect.signTransaction(base64txn));
            base64SignedTxn = AlgoSigner.encoding.msgpackToBase64(signedTxn.blob);
            break;
          default: break;
        }
        if (base64SignedTxn != null) {
            signedTxnElement.innerHTML = base64SignedTxn;
            sendTxnButton.style.display = "inline"
        }
      }
      async function sendTxn() {
        if (signedTxn == null)
          return;
        const network = ["TestNet", "MainNet"][document.forms[0].network.value]
        AlgoSigner.send({
            ledger: network,
            tx: base64SignedTxn
        }).then(response => console.log(response))
          .catch(err => console.error(err))
      }
    </script>
  </body>
</html>
